name: Android Release

on:
  push:
    tags:
      - 'android/v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

    - name: Set up JDK 17
      uses: actions/setup-java@b36c23c0d998641eff861008f374ee103c25ac73 # v4.4.0
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Set up Ruby
      uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
      with:
        ruby-version: '3.1'
        bundler-cache: true
        bundler-gemfile: androidApp/Gemfile

    - name: Grant execute permission for gradlew
      run: chmod +x androidApp/gradlew

    - name: Decode keystore
      run: |
        mkdir -p .secrets
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > .secrets/my-release-key.jks

    - name: Create keystore.properties
      run: |
        cat > .secrets/keystore.properties << EOF
        storeFile=.secrets/my-release-key.jks
        storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
        keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
        EOF

    - name: Build release APK
      run: cd androidApp && bundle exec fastlane build_release

    - name: Build release AAB
      run: cd androidApp && bundle exec fastlane build_bundle

    - name: Upload APK artifact
      uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097 # v4.4.2
      with:
        name: release-apk
        path: androidApp/app/build/outputs/apk/release/*.apk
        retention-days: 30

    - name: Upload AAB artifact
      uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097 # v4.4.2
      with:
        name: release-aab
        path: androidApp/app/build/outputs/bundle/release/*.aab
        retention-days: 30

    - name: Clean up secrets
      if: always()
      run: rm -rf .secrets

  github-release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
      with:
        fetch-depth: 0

    - name: Download APK artifact
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: release-apk
        path: artifacts/apk

    - name: Download AAB artifact
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: release-aab
        path: artifacts/aab

    - name: Extract version from tag
      id: version
      run: echo "version=${GITHUB_REF_NAME#android/v}" >> "$GITHUB_OUTPUT"

    - name: Extract changelog for this version
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
        echo "$NOTES" > /tmp/changelog-section.md

    - name: Build release body
      run: |
        cat > /tmp/release-notes.md << 'HEADER'
        ## Rollout Status

        | Stage | Status | Updated |
        |-------|--------|---------|
        | Internal Testing | ⏳ Pending | — |
        | Closed Alpha | ⏳ Pending | — |
        | Production | ⏳ Pending | — |

        ## Changes
        HEADER
        cat /tmp/changelog-section.md >> /tmp/release-notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
      with:
        name: "Android v${{ steps.version.outputs.version }}"
        body_path: /tmp/release-notes.md
        files: |
          artifacts/apk/*.apk
          artifacts/aab/*.aab

  deploy-internal:
    needs: github-release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

    - name: Set up Ruby
      uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
      with:
        ruby-version: '3.1'
        bundler-cache: true
        bundler-gemfile: androidApp/Gemfile

    - name: Download AAB artifact
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: release-aab
        path: artifacts/aab

    - name: Decode Play Store service account JSON
      run: |
        mkdir -p .secrets
        echo "${{ secrets.PLAY_STORE_JSON_BASE64 }}" | base64 -d > .secrets/thedeadly-app-f48493c2a133.json

    - name: Extract version from tag
      id: version
      run: echo "version=${GITHUB_REF_NAME#android/v}" >> "$GITHUB_OUTPUT"

    - name: Extract release notes from CHANGELOG
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        SERVER="${{ github.server_url }}"
        REPO="${{ github.repository }}"
        FOOTER=$'\n\nFull notes: '"${SERVER}/${REPO}/releases/tag/android/v${VERSION}"
        MAX_NOTES=$(( 500 - ${#FOOTER} - 3 ))
        RAW=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md | sed '/^[[:space:]]*$/d')
        if [ ${#RAW} -gt $MAX_NOTES ]; then
          RAW="${RAW:0:$MAX_NOTES}..."
        fi
        NOTES="${RAW}${FOOTER}"
        echo "RELEASE_NOTES<<EOF" >> "$GITHUB_ENV"
        echo "$NOTES" >> "$GITHUB_ENV"
        echo "EOF" >> "$GITHUB_ENV"

    - name: Upload to Play Store Internal Testing
      id: deploy
      run: |
        cd androidApp
        bundle exec fastlane upload_internal aab:${{ github.workspace }}/artifacts/aab/app-release.aab

    - name: Update release status (success)
      if: success()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        chmod +x scripts/update-release-status.sh
        ./scripts/update-release-status.sh "${{ steps.version.outputs.version }}" "Internal Testing" deployed

    - name: Update release status (failure)
      if: failure() && steps.deploy.outcome == 'failure'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        chmod +x scripts/update-release-status.sh
        ./scripts/update-release-status.sh "${{ steps.version.outputs.version }}" "Internal Testing" failed

    - name: Clean up secrets
      if: always()
      run: rm -rf .secrets
