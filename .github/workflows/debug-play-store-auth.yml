name: Debug Play Store Auth

on:
  workflow_dispatch:

jobs:
  debug-auth:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

    - name: Decode Play Store service account JSON
      run: |
        mkdir -p .secrets
        echo "${{ secrets.PLAY_STORE_JSON_BASE64 }}" | base64 -d > .secrets/thedeadly-app-f48493c2a133.json

    - name: Verify decoded file
      run: |
        echo "=== File info ==="
        ls -la .secrets/thedeadly-app-f48493c2a133.json
        file .secrets/thedeadly-app-f48493c2a133.json
        wc -c .secrets/thedeadly-app-f48493c2a133.json

        echo "=== JSON structure (keys only, no secrets) ==="
        python3 -c "
        import json
        d = json.load(open('.secrets/thedeadly-app-f48493c2a133.json'))
        print('type:', d.get('type'))
        print('project_id:', d.get('project_id'))
        print('client_email:', d.get('client_email'))
        print('has private_key:', 'private_key' in d)
        print('all keys:', sorted(d.keys()))
        "

        echo "=== Path resolution from androidApp/fastlane/ ==="
        realpath androidApp/fastlane/../../.secrets/thedeadly-app-f48493c2a133.json

    - name: Test Google Play API auth directly
      run: |
        pip3 install google-auth google-api-python-client -q
        python3 -c "
        from google.oauth2 import service_account
        from googleapiclient.discovery import build

        creds = service_account.Credentials.from_service_account_file(
            '.secrets/thedeadly-app-f48493c2a133.json',
            scopes=['https://www.googleapis.com/auth/androidpublisher'])
        print('Service account:', creds.service_account_email)

        svc = build('androidpublisher', 'v3', credentials=creds)
        edit = svc.edits().insert(body={}, packageName='com.grateful.deadly').execute()
        print('Edit created:', edit['id'])
        svc.edits().delete(packageName='com.grateful.deadly', editId=edit['id']).execute()
        print('Google Play API auth: OK')
        "

    - name: Set up Ruby and Fastlane
      uses: ruby/setup-ruby@a6e6f86333f0a2523ece813039b8b4be04560854 # v1.190.0
      with:
        ruby-version: '3.1'
        bundler-cache: false

    - name: Install fastlane
      run: gem install fastlane

    - name: Test Fastlane Play Store auth
      run: |
        cd androidApp
        fastlane run validate_play_store_json_key json_key:../../.secrets/thedeadly-app-f48493c2a133.json || echo "validate_play_store_json_key failed"

        echo "=== Trying upload_to_play_store with validate_only ==="
        fastlane run upload_to_play_store \
          package_name:com.grateful.deadly \
          json_key:../../.secrets/thedeadly-app-f48493c2a133.json \
          track:internal \
          validate_only:true \
          skip_upload_aab:true \
          skip_upload_apk:true \
          skip_upload_metadata:true \
          skip_upload_images:true \
          skip_upload_screenshots:true || echo "upload_to_play_store validate failed"

    - name: Clean up
      if: always()
      run: rm -f .secrets/thedeadly-app-f48493c2a133.json
